<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category   design_default
 * @package    Mage
 * @copyright  Copyright (c) 2008 Irubin Consulting Inc. DBA Varien (http://www.varien.com)
 * @license    http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/**
 * Product view template
 *
 * @see Mage_Catalog_Block_Product_View
 * @see Mage_Review_Block_Product_View
 */
?>

<?php

/* ZP-CODE:1 Handling IFRAME order requests */

$_helper = $this->helper('catalog/output');
$_product = $this->getProduct();

$button = "";
$img = $_product->getData("w2p_image");

if ($img && !$_product->getData("w2p_isorder")) {
  $button = '<input type="button" name="sosanh" value="PERSONALIZE" class="Personallize" onclick="document.location=\'' . $_product->getProductUrl() . '?preview=1&order=\';return false;"/>';
}

$is_preview = isset($_REQUEST['preview']);
$order = isset($_REQUEST['order']) ? $_REQUEST['order'] : "";

if (isset($_REQUEST['order']) && $_REQUEST['order']) {
  $is_preview = 0;
}

if ($order) {
  $logic = Mage::getModel('api/w2puser');
  $ret = $logic->order($order);

  if ($ret > 0) {
    echo '<script type="text/javascript">parent.document.location="' . $this->getUrl('checkout/cart/add') . '?&qty=1&product=' . $ret .'";</script>';
  } else {
    echo '<script type="text/javascript">parent.document.location="' . $this->getUrl('checkout/cart') .'";</script>';
  }

  return;
}

if ($img && $is_preview) {
  $logic = Mage::getModel('api/w2puser');
  $template_id = trim($_product->getSku());

  //Show zetaprint's page in iframe if 'Show IFRAME always' option is selected
  if (Mage::getStoreConfig('api/settings/zetaprints-show-previews-in-option') == 'zetaprints-iframe') {
    $w2p_url = $logic->getPersonalizeUrl($template_id);
    echo '<iframe src="' . $w2p_url .'" width="100%" height="1800px"></iframe>';
    return;
  }

  //Getting template details
  $xml = zetaprints_get_template_details_as_xml($template_id);

  if ($xml) {
    //Converting template details xml to html form 
    $preview_html =  zetaprints_get_preview_html_from_template_details($xml);
  } else {
    $preview_html = "<h1>Oops</h1>";
  }
}

/* ZP-CODE:1 End */

?>

<script type="text/javascript">
    var optionsPrice = new Product.OptionsPrice(<?php echo $this->getJsonConfig() ?>);
</script>

<div id="messages_product_view"><?php echo $this->getMessagesBlock()->getGroupedHtml() ?></div>

<div class="product-info-box">
    <div class="product-essential">

    <?php /* ZP-CODE:2 Checking if 'Personilize' button was pressed to show Magento form*/ ?>

    <?php if ($img && $is_preview): ?>
      <?php echo $preview_html ?>
    <?php else: ?>

    <?php /* ZP-CODE:2 End */ ?>

    <form action="<?php echo $this->getAddToCartUrl($_product) ?>" method="post" id="product_addtocart_form"<?php if($_product->getOptions()): ?> enctype="multipart/form-data"<?php endif; ?>>

        <div class="product-img-box">
            <?php echo $this->getChildHtml('media') ?>
        </div>

        <div class="product-shop">
            <h3 class="product-name">
                <?php echo $_helper->productAttribute($_product, $this->htmlEscape($_product->getName()), 'name') ?>
            </h3>

            <?php if ($this->canEmailToFriend()): ?>
                <a href="<?php echo $this->helper('catalog/product')->getEmailToFriendUrl($_product) ?>"><?php echo $this->__('Email to a Friend') ?></a><br />
            <?php endif; ?>

            <?php echo $this->getReviewsSummaryHtml($_product, false, true)?>

            <fieldset class="no-display">
              <input type="hidden" name="product" value="<?php echo $_product->getId() ?>" />
              <input type="hidden" name="related_product" id="related-products-field" value="" />
            </fieldset>

            <?php echo $this->getChildHtml('alert_urls') ?>
            <?php echo $this->getChildHtml('product_type_data') ?>
            <?php echo $this->getTierPriceHtml() ?>

            <?php if (!$this->hasOptions()):?>
                <div class="add-to-holder">
                    <?php if($_product->isSaleable()): ?>
                        <?php echo $this->getChildHtml('addtocart') ?>
                        <?php if( $this->helper('wishlist')->isAllow() || $_compareUrl=$this->helper('catalog/product_compare')->getAddUrl($_product)): ?>
                            <span class="add-or"><?php echo $this->__('OR') ?></span>
                        <?php endif; ?>
                    <?php endif; ?>
                    <?php echo $this->getChildHtml('addto') ?>
                </div>
            <?php else:?>
                <?php echo $this->getChildHtml('addto') ?>
            <?php endif; ?>

            <div class="divider"></div>

            <?php if ($_product->getShortDescription()):?>
                <h4><?php echo $this->__('Quick Overview') ?></h4>
                <div class="short-description"><?php echo $_helper->productAttribute($_product, nl2br($_product->getShortDescription()), 'short_description') ?></div>
            <?php endif;?>

            <?php echo $this->getChildHtml('other');?>

            <?php if ($_product->isSaleable() && $this->hasOptions()):?>
                <?php echo $this->getChildChildHtml('container1', '', true, true) ?>
            <?php endif;?>

        </div>
        <div class="clear"></div>
        <?php if ($_product->isSaleable() && $this->hasOptions()):?>
            <?php echo $this->getChildChildHtml('container2', '', true, true) ?>
        <?php endif;?>
    </form>
    <script type="text/javascript">
            var productAddToCartForm = new VarienForm('product_addtocart_form');
            productAddToCartForm.submit = function(){
                    if (this.validator.validate()) {
                            this.form.submit();
                    }
            }.bind(productAddToCartForm);
    </script>
 
    <?php /* ZP-CODE:3 */ ?>
 
    <?php endif; ?>

    <?php /* ZP-CODE:3 End */ ?>

    </div>
    <div class="product-collateral">
        <?php if ($_description = $this->getChildHtml('description')):?>
            <div class="collateral-box">
                <div class="head">
                    <h4><?php echo $this->__('Product Description') ?></h4>
                </div>
                <?php echo $_description ?>
            </div>
        <?php endif;?>
        <?php if ($_additional = $this->getChildHtml('additional')):?>
            <div class="collateral-box">
                <div class="head">
                    <h4><?php echo $this->__('Additional Information') ?></h4>
                </div>
                <?php echo $_additional ?>
            </div>
        <?php endif;?>
        <?php echo $this->getChildHtml('upsell_products') ?>
        <?php echo $this->getChildHtml('product_additional_data') ?>
    </div>
</div>

<!-- ZP-CODE:4 Javascript for Magento form -->

<script type="text/javascript">
  function update_preview (page) {
    jQuery('#ajax-loader').show(1);
    new Ajax.Request('<?php echo $_product->getProductUrl() ?>', {
      method: 'post',
      onSuccess: function (transport) {
        var response = transport.responseText;
        $$('form#' + page + ' div.product-img-box img')[0].writeAttribute('src', value = response);
        jQuery('<input type="hidden" name="previews" />').attr('value', response.split('/preview/')[1]).appendTo(jQuery('form#' + page));
        jQuery('form.zetaprints-template-page input.save-order').show();
        jQuery('#ajax-loader').hide(1); },
      onFailure: function () {
        jQuery('#ajax-loader').hide(1);
	alert('Can\'t get preview image.'); },
      parameters: $(page).serialize(true)
    });
  }

  jQuery(document).ready(function($) {
      var template_id = $('form.zetaprints-template-page input[name=zetaprints-TemplateID]').attr('value');

      $('form.zetaprints-template-page input.save-order').click(function () {
        $('#ajax-loader').show(1);

        var previews = '';

        $('form.zetaprints-template-page input[name=previews]').each(function () {
	  previews += $(this).attr('value') + ',';
        });

        previews = previews.substring(0, previews.length - 1);

        $.ajax({
	  url: '<?php echo $_product->getProductUrl() ?>/?save-order',
	  type: 'POST',
	  data: 'zetaprints-TemplateID=' + template_id + '&zetaprints-Previews=' + previews,
	  dataType: 'text',
	  error: function (XMLHttpRequest, textStatus, errorThrown) {
	    $('#ajax-loader').hide(1);
	    alert('Can\'t save order'); },
	  success: function (data, textStatus) {
            if (parseInt(data) > 0) {
              parent.document.location = '<?php echo $this->getUrl('checkout/cart/add'); ?>?qty=1&product=' + data;
            } else {
              parent.document.location = '<?php echo $this->getUrl('checkout/cart'); ?>';
            }}
	});
      });

    $('form.zetaprints-template-page ul.colors-selector li').each(function () {
      var color_sample = $('div.color-sample', this);
      var color_input = $('input.color', this);

      $(color_sample).ColorPicker({
        color: '#804080',
	onBeforeShow: function (colpkr) {
          $(colpkr).draggable();
	  return false;
	},
        onShow: function (colpkr) {
          $(colpkr).fadeIn(500);
	  return false;
        },
        onHide: function (colpkr) {
	  $(colpkr).fadeOut(500);
	  return false;
        },
	onSubmit: function (hsb, hex, rgb, el) {
          $(color_sample).css('backgroundColor', '#' + hex);
          $(color_input).val('#' + hex).attr('checked', true).change();
          $(el).ColorPickerHide();
        }
      });
    });

    $('form.zetaprints-template-page div.product-img-box img[rel="preview"]').each(function () {
      var image = this;
      $(image).qtip({
        content: {
        title: { text: 'Full size image', button: 'Close' },
	text: '<img src="' + $(image).attr('src') + '" />' },
        position: { target: $(document.body), corner: 'center' },
        show: { when: 'click', solo: true },
        hide: false,
	style: { width: 'auto', border: { width: 3, radius: 3 } },
        api: {
          beforeShow: function() {
	    $('img', this.elements.content).attr('src', $(image).attr('src'));
            $('#qtip-blanket').fadeIn(this.options.show.effect.length);},
          beforeHide: function() { $('#qtip-blanket').fadeOut(this.options.hide.effect.length); }
        }
      });
    });

    $('<div id="qtip-blanket">').css({
      position: 'absolute',
      top: $(document).scrollTop(),
      left: 0,
      height: $(document).height(),
      width: '100%',
      opacity: 0.7,
      backgroundColor: 'black',
      zIndex: 5000 }).appendTo(document.body).hide();

    $('form.zetaprints-template-page input[title], form.zetaprints-template-page textarea[title]').qtip({
      position: { corner: { target: 'bottomLeft' } },
	  show: { delay: 1, solo: true, when: { event: 'focus' } },
	  hide: { when: { event: 'unfocus' } }
    });

    $('form.zetaprints-template-page select[title]').qtip({
      position: { corner: { target: 'topLeft' }, adjust: { y: -30 } },
	  show: { delay: 1, solo: true, when: { event: 'focus' } },
	  hide: { when: { event: 'unfocus' } }
    });

    $('form.zetaprints-template-page select.stock-images-selector').msDropDown();

    $('form.zetaprints-template-page ul.colors-selector').vchecks();

    var height
    $('<img src="<?php echo $this->getSkinUrl('images/ajax-loader.gif'); ?>" id="ajax-loader" />').css({
      position: 'absolute',
	  right: 0,
          top: 0,
          zIndex: 1000 }).appendTo('form.zetaprints-template-page div.product-shop').hide();
  });
</script>

<!-- ZP-CODE:4 End -->
