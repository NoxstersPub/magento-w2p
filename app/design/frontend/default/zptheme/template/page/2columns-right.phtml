<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category   design_default
 * @package    Mage
 * @copyright  Copyright (c) 2008 Irubin Consulting Inc. DBA Varien (http://www.varien.com)
 * @license    http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/**
 * Template for Mage_Page_Block_Html
 */
?>
<?php

/* ZP-CODE:1 Handling AJAX requests (preview image requests, save order requests) */

//Checking for personilizing ajax request
if (isset($_REQUEST['zetaprints-TemplateID'])) {
  $params = array();

  //Preparing params for image generating request to zetaprints
  while (list($key, $value) = each($_REQUEST)) {
    if (strpos($key, 'zetaprints-') !== false) {
      $_key = substr($key, 11);
      $_key = substr($_key, 0, 1).str_replace('_', '%20', substr($_key, 1));
      $params[$_key] = $value;
    }
  }

  if (!defined('ZP_API_VER')) {
    $zetaprints_api_file = Mage::getRoot().'/code/local/Biinno/Api/Model/zp_api.php';

    if (file_exists($zetaprints_api_file)) {
      require $zetaprints_api_file;
    }
  }

  $w2p_user = Mage::getModel('api/w2puser');

  $params['ApiKey'] = $w2p_user->key;

  $user_credentials = $w2p_user->get_credentials();
  $params['ID'] = $user_credentials['id'];
  $params['Hash'] = zetaprints_generate_user_password_hash($user_credentials['password']);

  //Checking if 'Add to card' button was pressed
  if (isset($_REQUEST['save-order'])) {
    //Saving order in zetaprints for futher processing
    list($header, $content) = zp_api_common_post_request(Mage::getStoreConfig('api/settings/w2p_url'), '/api.aspx?page=api-order-save', $params);

    list(, $order_id) = explode("\r\n", $content);

    //Validating order id
    if (preg_match('/^[A-Z0-9]{8}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{12}$/', $order_id)) {
      //Adding order to magento if its id is valid.
      echo $w2p_user->order($order_id);
    } else {
      echo '0';
    }

    return;
  }

  //Sending image generating request to zetaprints
  list($header, $content) = zp_api_common_post_request(Mage::getStoreConfig('api/settings/w2p_url'), '/api.aspx?page=api-preview', $params);

  //BUG. Getting strange numbers in the content
  list(, $url) = explode("\r\n", $content);

  //Returning an url to generated image
  echo $url;

  return;
}

/* ZP-CODE:1 End */

if (isset($_REQUEST['save-order'])) {

}

/* ZP-CODE:2 */
 
//Checking if 'Personilize' button was pressed and option 'Show IFRAME always' was selected
$is_iframe = isset($_REQUEST['preview']) && (Mage::getStoreConfig('api/settings/w2p_using_iframe') == 'show_iframe_always');

/* ZP-CODE:2 End */

?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="<?php echo $this->getLang() ?>" lang="<?php echo $this->getLang() ?>">
<head>
    <?php echo $this->getChildHtml('head') ?>

    
    <!-- ZP-CODE:3 Resources for embedded personilizing form -->

    <script type="text/javascript" src="<?php echo $this->getSkinUrl('js/jquery-1.3.2.min.js'); ?>"></script>
    <script type="text/javascript" src="<?php echo $this->getSkinUrl('js/jquery-ui-1.7.2.custom.min.js'); ?>"></script>
    <script type="text/javascript" src="<?php echo $this->getSkinUrl('js/colorpicker.js'); ?>"></script>
    <script type="text/javascript" src="<?php echo $this->getSkinUrl('js/jquery-qtip-1.0.0-rc3.min.js'); ?>"></script>
    <script type="text/javascript" src="<?php echo $this->getSkinUrl('js/jquery.dd.js'); ?>"></script>
    <script type="text/javascript" src="<?php echo $this->getSkinUrl('js/jquery.vchecks.js'); ?>"></script>
    <link rel="stylesheet" type="text/css" href="<?php echo $this->getSkinUrl('css/colorpicker.css'); ?>"  />
    <link rel="stylesheet" type="text/css" href="<?php echo $this->getSkinUrl('css/dd.css'); ?>"  />
    <link rel="stylesheet" type="text/css" href="<?php echo $this->getSkinUrl('css/checks.css'); ?>"  />
    <link rel="stylesheet" type="text/css" href="<?php echo $this->getSkinUrl('css/zp-style.css'); ?>"  />

    <!-- ZP-CODE:3 End -->

</head>
<body <?php echo $this->getBodyClass()?'class="'.$this->getBodyClass().'"':'' ?>>

<?php /* ZP-CODE:4 */ ?>

<?php if (!$is_iframe): ?>

<?php /* ZP-CODE:4 End */ ?>

<div class="wrapper">
<?php /*<p class="demo-notice"><?php echo $this->__('This is a demo store. Any orders placed through this store will not be honored or fulfilled.') ?></p> */ ?>
        <!-- start header -->
        <div class="header">
            <?php echo $this->getChildHtml('header') ?>
        </div>
        <!-- end header -->

        <!-- start middle -->
        <div class="middle-container">
            <div class="middle col-2-right-layout">
<?php echo $this->getChildHtml('breadcrumbs') ?>
            <!-- start center -->
                <div id="main" class="col-main">
                <!-- start global messages -->
                    <?php echo $this->getChildHtml('global_messages') ?>
                <!-- end global messages -->

                <!-- start content -->
                    <?php echo $this->getChildHtml('content') ?>&nbsp;
                <!-- end content -->
                </div>
            <!-- end center -->

            <!-- start right -->
            <div class="col-right side-col">
                <?php echo $this->getChildHtml('right') ?>&nbsp;
            </div>
            <!-- end right -->

        </div>
            </div>
        <!-- end middle -->

        <!-- start footer -->
        <div class="footer-container">
            <div class="footer">
                <?php echo $this->getChildHtml('footer') ?>
            </div>
        </div>
        <!-- end footer -->

<?php echo $this->getChildHtml('before_body_end') ?>
</div>
<?php echo $this->getAbsoluteFooter() ?>

<?php /* ZP-CODE:5 Minimal html code for page with IFRAME*/ ?>

<?php else: ?>
  <div class="wrapper">
    <div class="header">
      <?php echo $this->getChildHtml('header') ?>
    </div>
  </div>
  <?php echo $this->getChildHtml('content') ?>
  <div class="wrapper">
    <div class="footer">
      <?php echo $this->getChildHtml('footer') ?>
    </div>
  </div>
<?php endif;?>

<?php /* ZP-CODE:5 End */ ?>

</body>
</html>